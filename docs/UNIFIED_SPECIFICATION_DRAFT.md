# Polimoney 統合仕様書（案）

> ⚠️ **ドラフト版** - このドキュメントは検討中の仕様です。実装時に変更される可能性があります。

## 1. 概要

Polimoney エコシステムは、政治資金の透明化を目的とした 3 つのプロダクトで構成されます。

| プロダクト           | 役割                         | 対象ユーザー           |
| -------------------- | ---------------------------- | ---------------------- |
| **Polimoney**        | 政治資金の可視化             | 市民、研究者、メディア |
| **Polimoney Hub**    | マスタデータ管理、データ連携 | 管理者、API 消費者     |
| **Polimoney Ledger** | 政治資金収支の記録・管理     | 政治家、会計責任者     |

---

## 2. アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Polimoney エコシステム                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                        Polimoney Hub                                     ││
│  │  - 共通識別子管理（政治家ID、政治団体ID、選挙ID）                        ││
│  │  - 政治家ページ、政治団体ページ（公開）                                  ││
│  │  - 認証・本人確認                                                        ││
│  │  - データ連携・匿名化                                                    ││
│  │                                                                          ││
│  │  ┌────────────────────────────────────────────────────────────────┐    ││
│  │  │ 🅱️ Supabase Project B (Hub 専用)                               │    ││
│  │  │    - PostgreSQL: politicians, political_organizations          │    ││
│  │  │    - PostgreSQL: elections, public_ledgers, public_journals    │    ││
│  │  │    - Supabase Auth: 管理者認証                                 │    ││
│  │  └────────────────────────────────────────────────────────────────┘    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                              │                                               │
│                              │ API (認証付き)                                │
│          ┌───────────────────┴───────────────────┐                          │
│          │                                       │                          │
│          ▼                                       ▼                          │
│  ┌────────────────────────────────┐      ┌───────────────┐                 │
│  │ Polimoney Ledger               │      │ Polimoney     │                 │
│  │ (政治家向け収支管理)           │      │ (可視化)      │                 │
│  │                                │      │               │                 │
│  │  ┌──────────────────────────┐  │      │ 公開データを  │                 │
│  │  │ 🅰️ Supabase Project A     │  │      │ Hub経由で取得 │                 │
│  │  │    (Ledger 専用)          │  │      │               │                 │
│  │  │    - PostgreSQL: journals │  │      └───────────────┘                 │
│  │  │    - PostgreSQL: contacts │  │                                        │
│  │  │    - Supabase Auth: OTP   │  │                                        │
│  │  │    - Supabase Storage     │  │                                        │
│  │  └──────────────────────────┘  │                                        │
│  └────────────────────────────────┘                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. アカウントとアイデンティティ

### 3.1. 基本方針

- **1 人（1 メールアドレス）につき 1 アカウント**
- 登録時に政治家 ID は発行しない（別途申請・承認が必要）
- なりすまし防止のため、公式ドメインのメール認証を必須とする

### 3.2. アカウント種別

| 種別                   | 説明                                       | 権限                       |
| ---------------------- | ------------------------------------------ | -------------------------- |
| **一般ユーザー**       | メール認証のみ完了したアカウント           | 招待された台帳の閲覧・操作 |
| **認証済み政治家**     | 政治家 ID が付与されたアカウント           | 選挙台帳の作成・管理       |
| **認証済み団体管理者** | 政治団体の管理者として認証されたアカウント | 政治団体台帳の作成・管理   |

### 3.3. 政治家 ID の付与フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. アカウント作成（一般ユーザー）                                           │
│    - メールアドレス + パスワード                                            │
│    - OTP認証                                                                │
│    - 利用規約・プライバシーポリシーへの同意（必須）                         │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. 政治家として認証申請                                                     │
│    - 公式ドメインのメールアドレスを入力（例: tanaka@tanaka-taro.jp）        │
│    - そのメールアドレスに認証コードを送信                                   │
│    - 認証コードを入力して確認                                               │
│    ※ 公式メールを持っていない場合は認証不可（フォールバックなし）          │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. Hub管理者が承認                                                          │
│    - 申請内容を確認                                                         │
│    - 承認 → 政治家IDをアカウントに付与                                      │
│    - 政治家ページに公開                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4. 政治団体の管理者認証フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. アカウント作成（一般ユーザー）                                           │
│    - （上記と同様）                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. 政治団体の管理者として認証申請                                           │
│    - 政治団体名を検索・選択（または新規申請）                               │
│    - 政治団体の公式メールアドレスを入力                                     │
│    - そのメールアドレスに認証コードを送信                                   │
│    - 認証コードを入力して確認                                               │
│    ※ 公式メールを持っていない場合は認証不可（フォールバックなし）          │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. Hub管理者が承認                                                          │
│    - 申請内容を確認                                                         │
│    - 承認 → そのアカウントを政治団体の管理者として登録                      │
│    - 政治団体ページに公開                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 公開ページと通報機能

### 4.1. 政治家ページ（Hub）

政治家 ID を発行した全員を公開ページに掲載します。

**掲載情報:**

- 氏名
- 顔写真（任意）
- 政党 または 無所属
- 公式サイト URL（認証済みドメインに限る）

**登録方法:**

- Ledger から登録可能

### 4.2. 政治団体ページ（Hub）

認証済みの政治団体を公開ページに掲載します。

**掲載情報:**

- 団体名
- 種別（政党支部、資金管理団体、後援会など）
- 届出先（総務省/都道府県選管/市区町村選管）
- 公式サイト URL（認証済みドメインに限る）

### 4.3. 通報機能（「私ではありません」）

なりすまし被害を防ぐため、本人からの通報を受け付けます。

**通報フロー:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 「私ではありません」ボタンをクリック                                     │
│    - 政治家ページ内に設置                                                   │
│    - 政治団体ページ内にも設置                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. 通報フォーム入力                                                         │
│    - 氏名（必須）                                                           │
│    - メールアドレス（必須）                                                 │
│    - 電話番号（必須）                                                       │
│    - 住所（任意 - 郵送確認希望時のみ）                                      │
│    - 証憑（必須）                                                           │
│      ・身分証明書（運転免許証、パスポート等）                               │
│      ・議員バッジの写真                                                     │
│      ・議員証                                                               │
│      ※ 名刺は不可（偽造しやすいため）                                      │
│    - 補足説明（任意）                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. Hub管理者が対応                                                          │
│    - 通報内容を確認                                                         │
│    - 必要に応じて電話・郵送で追加確認                                       │
│    - なりすまし確定 → 該当アカウントを停止                                  │
│    - 本人に結果を通知                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 台帳作成フロー

### 5.1. 選挙台帳の作成

**作成可能なアカウント:**

- 政治家 ID 保持者本人
- 政治家 ID 保持者が招待したアカウント（権限のあるロールのみ）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 選挙台帳の作成                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ 前提条件:                                                                   │
│ - 政治家IDを持つアカウント、または                                          │
│ - 政治家ID保持者から招待され、台帳作成権限を持つアカウント                  │
│                                                                              │
│ 作成フロー:                                                                 │
│ 1. Hubから選挙マスタを検索・選択（または新規選挙申請）                      │
│ 2. 選挙台帳を作成                                                           │
│ 3. 必要に応じてメンバーを招待                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2. 政治団体台帳の作成

**作成可能なアカウント:**

- 政治団体の管理者アカウント
- 政治団体の管理者が招待したアカウント（権限のあるロールのみ）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 政治団体台帳の作成                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ 前提条件:                                                                   │
│ - 政治団体の管理者として認証されたアカウント、または                        │
│ - 管理者から招待され、台帳作成権限を持つアカウント                          │
│                                                                              │
│ 作成フロー:                                                                 │
│ 1. 管理者として認証済みの政治団体を選択                                     │
│ 2. 政治団体台帳を作成                                                       │
│ 3. 必要に応じてメンバーを招待                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 権限とロール

### 6.1. 権限（Permission）

| 権限                 | 説明                                 |
| -------------------- | ------------------------------------ |
| `viewLedger`         | 台帳（仕訳一覧など）を閲覧する       |
| `submitJournal`      | 仕訳を起票（承認申請）する           |
| `registerJournal`    | 仕訳を即時登録（自己承認）する       |
| `approveJournal`     | 他人の仕訳を承認・却下する           |
| `manageMembers`      | メンバーの招待・削除・役割変更を行う |
| `manageContacts`     | 関係者マスタを編集する               |
| `editLedgerSettings` | 台帳設定を編集する                   |

### 6.2. ロール（Role）

| ロール         | 説明       | 権限                                                                                                       |
| -------------- | ---------- | ---------------------------------------------------------------------------------------------------------- |
| **admin**      | 管理者     | すべての権限                                                                                               |
| **accountant** | 経理担当者 | `viewLedger`, `submitJournal`, `registerJournal`, `approveJournal`, `manageContacts`, `editLedgerSettings` |
| **approver**   | 承認者     | `viewLedger`, `submitJournal`, `approveJournal`, `manageContacts`                                          |
| **submitter**  | 起票者     | `viewLedger`, `submitJournal`, `manageContacts`                                                            |
| **viewer**     | 閲覧者     | `viewLedger`                                                                                               |

### 6.3. メンバー招待

- 政治家 ID 保持者または政治団体管理者のみがメンバーを招待可能
- 招待されたメンバーは一般ユーザーとして台帳にアクセス
- 招待制であるため、なりすましが広まるリスクは限定的

---

## 7. なりすまし対策

### 7.1. 設計原則

| 対策                  | 採用 | 理由                       |
| --------------------- | ---- | -------------------------- |
| **公式メール認証**    | ✅   | ドメイン所有を確認できる   |
| **招待制**            | ❌   | なりすましが広まるリスク   |
| **書類審査**          | ❌   | 偽造リスク、手動対応の負荷 |
| **公開ページ + 通報** | ✅   | 公共の目による監視         |

### 7.2. Whois 情報について

Whois 情報は入力するだけで登録できるため、本人確認には使用しません。
メール認証の方が確実です。

### 7.3. フィッシングサイト対策

オープンソースプロジェクトのため、クローンサイトを作られるリスクがあります。

**対策:**

1. 公式 URL の周知徹底
2. 利用規約でのフィッシング注意喚起
3. ログイン画面での警告表示

---

## 8. フッター免責事項（Polimoney 公開ページ）

Polimoney の各ページフッターには、以下の免責事項を表示します：

> 正確なデータを掲載したい意思はありますが、それは Polimoney 上のデータの正確性を保証するものではありません。
> 実際に提出された収支報告書は、総務省のサイトをご覧になるか、各政治家・団体にお問い合わせください。
> またその際、何度も同じ問い合わせを送るなどの行為がないよう、ご配慮頂けますと幸いです。

---

## 9. 利用規約（Ledger）

以下の文言を利用規約に追加します：

> **フィッシングサイトに関する注意事項**
>
> Polimoney Ledger はオープンソースソフトウェアとして開発されています。
> Web サイトは公に公開するという性質上、コピーされやすく、なりすましサイトの構築をされやすいものです。
> また、それは AI（LLM）の普及により、より容易くなっています。
>
> Polimoney Ledger は現状ベータ版での公開で無料のサービスです。
> ボランティアによる運営のため、サポートが行き届かない可能性があります。
>
> フィッシングサイトには十分にご注意頂き、ご利用ください。
>
> **公式 URL:** https://ledger.polimoney.jp（予定）

### 9.1. 登録時の同意

アカウント登録時に以下のチェックボックスを表示し、同意を必須とします：

- [ ] 利用規約に同意する
- [ ] プライバシーポリシーに同意する

---

## 10. 実装ロードマップ（案）

### Phase 1: 認証基盤の強化

1. **Ledger**

   - [ ] 利用規約・プライバシーポリシー同意チェックボックス追加
   - [ ] フィッシング注意の利用規約文言追加
   - [ ] 登録フローの見直し

2. **Hub**
   - [ ] 政治家認証申請 API
   - [ ] 政治団体管理者認証申請 API
   - [ ] 公式メール認証フロー

### Phase 2: 公開ページと通報機能

1. **Hub**
   - [ ] 政治家一覧ページ
   - [ ] 政治家詳細ページ
   - [ ] 政治団体一覧ページ
   - [ ] 政治団体詳細ページ
   - [ ] 「私ではありません」通報フォーム
   - [ ] 通報管理画面

### Phase 3: 台帳作成フローの変更

1. **Ledger**

   - [ ] 選挙台帳作成フローの変更（政治家 ID 必須）
   - [ ] 政治団体台帳作成フローの変更（管理者認証必須）
   - [ ] メンバー招待フローの見直し

2. **Hub**
   - [ ] 選挙マスタ API（認証付き）
   - [ ] 政治団体マスタ API（認証付き）

### Phase 4: 権限管理の強化

1. **Ledger**
   - [ ] ロール・権限の見直し
   - [ ] 台帳作成権限のチェック強化

---

## 11. 変更履歴

| 日付       | バージョン | 変更内容             |
| ---------- | ---------- | -------------------- |
| 2024-12-17 | 0.1.0      | 初版作成（ドラフト） |
| 2024-12-17 | 0.1.1      | フッター免責事項を追加 |

---

## 12. 関連ドキュメント

- [Polimoney Hub アーキテクチャ](../polimoney_hub/docs/ARCHITECTURE.md)
- [Polimoney Ledger アーキテクチャ](../polimoney_ledger/docs/ARCHITECTURE.md)
- [Polimoney Ledger 機能仕様書](../polimoney_ledger/docs/SPECIFICATION.md)
